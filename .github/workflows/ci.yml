---
name: ci

on:
  # for feature branches
  pull_request:
  # for rebar.lock updates
  push:
    branches:
      - renovate/**

concurrency:
  group: ${{ (github.ref != 'refs/heads/master') && format('{0}-{1}', github.ref, github.workflow) || github.run_id }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}

jobs:
  ci:
    name: ci
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          otp-version: 26
          rebar3-version: 3.24

      - run: |
          if [[ "${HEAD_REF}" =~ renovate/.* ]]; then
            echo "ℹ️ This appears to come from a Renovate PR. Trying rebar.lock update..."

            CHANGED=false
            ORIGIN="origin/${{ github.event.repository.default_branch }}"

            git config user.name "kivrabot"
            git config user.email "kivrabot@users.noreply.github.com"

            if ! git diff --quiet --exit-code "${ORIGIN}"..HEAD -- rebar.config; then
              rebar3 upgrade --all

              if ! git diff --quiet --exit-code rebar.lock; then
                # there's stuff to push
                git add rebar.lock
                CHANGED=true
              fi
            fi

            if [[ "${CHANGED}" == "true" ]]; then
              git commit -m "auto-update(deps): Changes in rebar.lock"
              git push origin HEAD:"${HEAD_REF}"
            fi
          fi
        env:
          HEAD_REF: ${{ github.head_ref }}

      - run: make ci
